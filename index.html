<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>HaskoningÂ â€“Â Risk Management Suite</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- SheetJS (builds XLSX files clientâ€‘side) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js"
        integrity="sha512-0Pf4biC0yNXbnzqgqLJ6wyJ1qpjXwzQVi+BK8WenY9L+p+XkvB98Vm2wFNkrmlEs0swGhXm89zGE8MVzO8GCNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
:root{
  --blue:#0f2a44;--green:#81c784;--orange:#ffab40;--grey:#e2e8f0;
  font-family:Inter,SegoeÂ UI,Arial,sans-serif;font-size:16px;line-height:1.5;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:linear-gradient(135deg,var(--blue)0%,#1a365d 100%);}
h1,h2{color:var(--blue);margin-bottom:.5rem}
.container{max-width:1100px;margin:3rem auto;padding:2rem;background:#fff;border-radius:12px}

.btn{display:inline-block;padding:.8rem 1.6rem;border:none;border-radius:8px;background:var(--blue);color:#fff;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}

.mode-card{padding:1.3rem;border:2px solid var(--grey);border-radius:12px;cursor:pointer;text-align:center;transition:.2s all}
.mode-card:hover{transform:translateY(-3px)}
.mode-card.active{background:linear-gradient(135deg,var(--green)0%,#66bb6a 100%);color:#fff}

.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin:1.5rem 0}
label{font-weight:600;color:var(--blue);margin-bottom:.3rem;display:block}
input,select,textarea{width:100%;padding:.7rem;border:2px solid var(--grey);border-radius:8px}
table{border-collapse:collapse;margin-top:2rem;width:100%}
th,td{border:1px solid #ddd;padding:.6rem;text-align:left}
th{background:#f8fafc}

.hidden{display:none}
.status{margin-top:1rem;padding:.8rem;border-radius:6px}
.status.ok{background:#e8f5e9;color:var(--blue)}
.status.err{background:#fff3e0;color:var(--blue)}
.status.progress{background:#c8e6c9;color:var(--blue)}

.dashboard{/* shown only for comparisons */margin-top:2rem}
.metric-card{background:linear-gradient(135deg,#f8fafc 0%,var(--grey)100%);padding:1rem;border-radius:8px;text-align:center}
.metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem}
</style>
</head>
<body>

<div class="container">
  <h2>Select Mode</h2>
  <div class="form-grid">
    <div id="mode-generate" class="mode-card active" onclick="setMode('generate')">
      <h3>ğŸ“Â Generate New Register</h3>
      <p>Produce a brandâ€‘new risk register from project parameters.</p>
    </div>
    <div id="mode-compare" class="mode-card" onclick="setMode('compare')">
      <h3>âš–ï¸Â Compare Two Registers</h3>
      <p>Upload two existing registers and analyse the differences.</p>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  GENERATE FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <form id="generate-form">
    <div class="form-grid">
      <div><label>ProjectÂ Name*</label><input id="g-project" required></div>
      <div><label>ProjectÂ Type*</label>
        <select id="g-type" required>
          <option value="">Selectâ€¦</option><option>Infrastructure</option><option>IT/Software</option>
          <option>Construction</option><option>Energy</option>
        </select></div>
      <div><label>Timeline*</label><input id="g-time" placeholder="e.g.Â 18Â months" required></div>
      <div><label>Country / Region*</label><input id="g-country" required></div>
      <div><label>RiskÂ Methodology*</label>
        <select id="g-method" required>
          <option value="">Selectâ€¦</option><option>3x3 Matrix</option><option>5x5 Matrix</option><option>Qualitative</option>
        </select></div>
      <div><label>NumberÂ ofÂ Risks*</label><input type="number" id="g-count" min="5" max="50" value="15" required></div>
      <div class="form-grid" style="grid-column:1/3">
        <label>AdditionalÂ Context</label><textarea id="g-context" rows="3" style="resize:vertical"></textarea>
      </div>
    </div>
    <button type="button" class="btn" onclick="generate()">ğŸš€Â Generate</button>
    <div id="g-status" class="status hidden"></div>
  </form>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  COMPARE FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <form id="compare-form" class="hidden">
    <div class="form-grid">
      <div>
        <label>OldÂ Register (.xlsx)</label>
        <input type="file" id="c-old" accept=".xlsx,.xls,.csv" required>
      </div>
      <div>
        <label>NewÂ Register (.xlsx)</label>
        <input type="file" id="c-new" accept=".xlsx,.xls,.csv" required>
      </div>
    </div>
    <label>ComparisonÂ ContextÂ (Optional)</label><textarea id="c-context" rows="3" style="resize:vertical"></textarea>

    <button type="button" class="btn" onclick="compare()">âš–ï¸Â Compare</button>
    <div id="c-status" class="status hidden"></div>
  </form>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  RESULTS: TABLE (generate)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="table-wrapper" class="hidden">
    <h2>ğŸ“‹Â Risk Register</h2>
    <table id="risk-table"></table>
    <button class="btn" onclick="downloadXLSX()">â¬‡ï¸Â DownloadÂ Spreadsheet</button>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  RESULTS: DASHBOARD (compare)â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="dashboard" class="dashboard hidden">
    <h2>ğŸ›¡ï¸Â ComparisonÂ Dashboard</h2>
    <div id="metrics" class="metric-grid"></div>
    <button class="btn" onclick="downloadXLSX()">â¬‡ï¸Â DownloadÂ Spreadsheet</button>
  </div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  GLOBAL  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let MODE='generate';          // generate | compare
let LAST_TABLE=[];            // array of objects received from backend
let FILE_NAME='Risk_Register.xlsx';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  MODE SWITCH  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setMode(m){
  MODE=m;
  // visual toggle
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('active'));
  document.getElementById('mode-'+m).classList.add('active');

  // show/hide forms
  document.getElementById('generate-form').classList.toggle('hidden',m!=='generate');
  document.getElementById('compare-form').classList.toggle('hidden',m!=='compare');

  // hide result areas
  document.getElementById('table-wrapper').classList.add('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  GENERATE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function generate(){
  const status=document.getElementById('g-status');
  status.className='status progress';status.textContent='â³Â Generatingâ€¦';status.classList.remove('hidden');

  const payload={
    mode:'generate_new',
    projectName:document.getElementById('g-project').value,
    projectType:document.getElementById('g-type').value,
    projectTimeline:document.getElementById('g-time').value,
    countryRegion:document.getElementById('g-country').value,
    riskMethodology:document.getElementById('g-method').value,
    numberOfRisks:+document.getElementById('g-count').value,
    additionalContext:document.getElementById('g-context').value
  };

  // basic required field check
  if(Object.values(payload).some(v=>v===''||v===null)){
    status.className='status err';status.textContent='âŒÂ Please fill in all required fields.';return;
  }

  try{
    const res=await fetch('https://steveyaghi.app.n8n.cloud/webhook-test/risk-webapp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json=await res.json();
    if(!json.success) throw new Error('Generation failed on server.');

    LAST_TABLE=json.report_data;
    FILE_NAME=json.filename||'Generated_Risk_Register.xlsx';

    buildHtmlTable(LAST_TABLE);
    document.getElementById('table-wrapper').classList.remove('hidden');
    status.className='status ok';status.textContent='âœ…Â Risk register generated!';
  }catch(err){
    status.className='status err';status.textContent='âŒÂ '+err.message;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  COMPARE  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function compare(){
  const status=document.getElementById('c-status');
  status.className='status progress';status.textContent='â³Â Comparingâ€¦';status.classList.remove('hidden');

  const oldFile=document.getElementById('c-old').files[0];
  const newFile=document.getElementById('c-new').files[0];
  if(!oldFile||!newFile){status.className='status err';status.textContent='âŒÂ Please select both files.';return;}

  // helper converts file â†’ base64 string
  const toB64=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(f);});

  const payload={
    mode:'compare_registers',
    file1:{name:oldFile.name,content:await toB64(oldFile)},
    file2:{name:newFile.name,content:await toB64(newFile)},
    comparisonContext:document.getElementById('c-context').value
  };

  try{
    const res=await fetch('https://steveyaghi.app.n8n.cloud/webhook-test/risk-webapp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json=await res.json();
    if(!json.success) throw new Error('Comparison failed on server.');

    LAST_TABLE=json.report_data;
    FILE_NAME=json.filename||'Risk_Comparison.xlsx';

    /* ---------- build dashboard metrics ---------- */
    document.getElementById('metrics').innerHTML=
      Object.entries(json.comparison_metrics||{}).map(([k,v])=>
        `<div class="metric-card"><div style="font-size:1.8rem;font-weight:700">${v}</div><div>${k.replace(/([A-Z])/g,' $1')}</div></div>`
      ).join('');

    document.getElementById('dashboard').classList.remove('hidden');
    buildHtmlTable(LAST_TABLE,true);   // also keep raw table for download
    status.className='status ok';status.textContent='âœ…Â Comparison complete!';
  }catch(err){
    status.className='status err';status.textContent='âŒÂ '+err.message;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  TABLE RENDERER  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildHtmlTable(rows,skipDisplay=false){
  if(!rows||!rows.length) return;
  const headers=Object.keys(rows[0]);
  const thead=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody=`<tbody>${rows.map(r=>`<tr>${headers.map(h=>`<td>${r[h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;

  if(!skipDisplay){
    document.getElementById('risk-table').innerHTML=thead+tbody;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  XLSX DOWNLOAD  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadXLSX(){
  if(!LAST_TABLE.length){alert('No data to download');return;}
  const ws=XLSX.utils.json_to_sheet(LAST_TABLE);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Risks');
  XLSX.writeFile(wb,FILE_NAME);
}
</script>
</body>
</html>
